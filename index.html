<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Jewels Try-On</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel&family=Poppins&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel&family=Poppins&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body, html {
      width: 100%; height: 100%;
      background-color: #0b0b0b;
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }

    video, canvas {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 1;
    }

    #branding {
      position: fixed; top: 21px; left: 20px;
      padding: 8px 12px; border-radius: 10px;
      display: flex; align-items: center;
      z-index: 5; font-family: 'Cinzel', serif;
      font-size: 24px; color: #000;
    }
    #branding img { width: 80px; height: auto; margin-right: 10px; }

    /* Main Jewelry Category Buttons */
    #jewelry-mode {
      position: fixed; bottom: 10px; left: 50%;
      transform: translateX(-50%);
      display: flex; flex-direction: row; gap: 12px;
      z-index: 5; background: rgba(0,0,0,0.6);
      padding: 10px 15px; border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    #jewelry-mode button {
      background-color: #5E0F8B; color: #fff;
      border: none; padding: 10px 12px;
      border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: background-color 0.3s ease;
    }
    #jewelry-mode button:hover { background-color: #3b0764; }

    /* Subcategory Buttons */
    #subcategory-buttons {
      position: fixed; bottom: 130px; left: 0;
      width: 100%; justify-content: center; z-index: 5;
      display: flex; gap: 12px; background: rgba(0,0,0,0.6);
      padding: 8px 12px; border-radius: 10px;
      backdrop-filter: blur(8px);
    }
    #subcategory-buttons button {
      background-color: #FFB800; color: #000;
      border: none; padding: 8px 10px;
      border-radius: 6px; cursor: pointer; font-weight: bold;
    }

    /* Jewelry Options Scroll */
    .options-group {
      position: fixed; bottom: 70px; left: 0;
      width: 100%; display: flex; gap: 15px;
      z-index: 2; background: #5E0F8B;
      backdrop-filter: blur(10px);
      padding: 10px 20px; border-radius: 16px;
      overflow-x: auto; scrollbar-width: none;
    }
    .options-group::-webkit-scrollbar { display: none; }
    .options-group button { background: transparent; border: none; cursor: pointer; transition: transform 0.2s ease; }
    .options-group button img {
      width: 60px; height: 60px; border-radius: 12px; transition: transform 0.2s ease;
    }
    .options-group button:hover img { border: 2px solid #fff; transform: scale(1.05); }

    /* UI Buttons */
    .ui-buttons {
      position: fixed; top: 20px; right: 20px;
      display: flex; gap: 15px; z-index: 5;
    }
    .ui-buttons button, .ui-buttons a {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 50%; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s ease;
    }
    .ui-buttons button:hover, .ui-buttons a:hover { background: rgba(255,255,255,0.4); }
    .ui-buttons img { width: 25px; height: 25px; }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="branding">
    <img src="logo.png" alt="Overlay Jewels Logo" class="logo-icon" />
  </div>

  <div class="ui-buttons">
    <a id="location-btn" href="https://maps.app.goo.gl/gsTuBCVMUVk9cxYZ6" target="_blank" rel="noopener noreferrer">
      <img src="location_icon.png" alt="Location" />
    </a>
  </div>
  
  <div id="jewelry-mode" class="button-group">
    <button onclick="toggleCategory('earrings')">EARRINGS</button>
    <button onclick="toggleCategory('necklaces')">CHAINS</button>
  </div>

  <div id="subcategory-buttons" class="button-group" style="display: none;">
    <button onclick="selectJewelryType(currentType, 'gold')">Gold</button>
    <button onclick="selectJewelryType(currentType, 'diamond')">Diamond</button>
  </div>
  
  <div id="jewelry-options" class="options-group" style="display: none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const videoElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('overlay');
    const canvasCtx = canvasElement.getContext('2d');
    const subcategoryButtons = document.getElementById('subcategory-buttons');
    const jewelryOptions = document.getElementById('jewelry-options');

    let earringImg = null, necklaceImg = null;
    let currentType = '', smoothedFaceLandmarks = null, camera;
    let smoothedFacePoints = {};

    // GOOGLE DRIVE CONFIG
    const API_KEY = "AIzaSyCOkk8w6DyEp5lwdm5DjECSo-c2Xitw9vI"; 
    const driveFolders = {
      gold_earrings: "16q2qkfEmeyMa45edfuRGwhJskQEbiwFS",
      gold_necklaces: "1yiCBSMk4HpxxZcPf2AQeQeAKMcNNQNxt",
      diamond_earrings: "177PssOxA552FjZS6OjtMpz-tRZzJuL26",
      diamond_necklaces: "1ffu4kbZMpWhw4bOLnB07z-HM8E5Lz7qz",
    };

    async function fetchDriveImages(folderId) {
      const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType)`;
      const res = await fetch(url); const data = await res.json();
      if (!data.files) return [];
      return data.files.filter(f=>f.mimeType.includes("image/"))
        .map(f => ({ id:f.id, name:f.name, src:`https://drive.google.com/thumbnail?id=${f.id}&sz=w1000` }));
    }

    async function loadImage(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }

    async function changeJewelry(type, src) {
      const img = await loadImage(src);
      if (!img) return;
      earringImg = necklaceImg = null;
      if (type.includes('earrings')) earringImg = img;
      else if (type.includes('necklaces')) necklaceImg = img;
    }

    function toggleCategory(category) {
      jewelryOptions.style.display = 'none';
      subcategoryButtons.style.display = 'none';
      currentType = category;
      subcategoryButtons.style.display = 'flex';
      startCamera('user');
    }

    function selectJewelryType(mainType, subType) {
      currentType = `${subType}_${mainType}`;
      subcategoryButtons.style.display = 'none';
      jewelryOptions.style.display = 'flex';
      insertJewelryOptions(currentType, 'jewelry-options');
    }

    async function insertJewelryOptions(type, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!driveFolders[type]) return;
      const images = await fetchDriveImages(driveFolders[type]);
      images.forEach((file, i) => {
        const btn = document.createElement('button');
        const img = document.createElement('img');
        img.src = file.src; img.alt = `${type} ${i+1}`;
        btn.appendChild(img);
        btn.onclick = () => changeJewelry(type, file.src);
        container.appendChild(btn);
      });
    }

    const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
    faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.6, minTrackingConfidence:0.6 });
    faceMesh.onResults((results) => {
      canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);
      if (results.multiFaceLandmarks?.length>0) {
        const newLandmarks = results.multiFaceLandmarks[0];
        if (!smoothedFaceLandmarks) smoothedFaceLandmarks = newLandmarks;
        else {
          const factor=0.2;
          smoothedFaceLandmarks = smoothedFaceLandmarks.map((prev,i)=>({
            x: prev.x*(1-factor)+newLandmarks[i].x*factor,
            y: prev.y*(1-factor)+newLandmarks[i].y*factor,
            z: prev.z*(1-factor)+newLandmarks[i].z*factor,
          }));
        }
      } else smoothedFaceLandmarks = null;
      drawJewelry(smoothedFaceLandmarks, canvasCtx);
    });

    async function startCamera(facingMode) {
      if (camera) camera.stop();
      camera = new Camera(videoElement, {
        onFrame: async () => { await faceMesh.send({ image: videoElement }); },
        width:1280, height:720, facingMode:facingMode
      });
      camera.start();
    }

    document.addEventListener('DOMContentLoaded', () => startCamera('user'));
    videoElement.addEventListener('loadedmetadata', () => {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;
    });

    function smoothPoint(prev, current, factor = 0.4) {
      if (!prev) return current;
      return { x: prev.x*(1-factor)+current.x*factor, y: prev.y*(1-factor)+current.y*factor };
    }

    function drawJewelry(faceLandmarks, ctx) {
      const earringScale = 0.078, necklaceScale = 0.252;
      if (faceLandmarks) {
        const leftEar = faceLandmarks[132], rightEar = faceLandmarks[361], neck = faceLandmarks[152];
        let leftEarPos = { x:leftEar.x*canvasElement.width-6, y:leftEar.y*canvasElement.height-16 };
        let rightEarPos = { x:rightEar.x*canvasElement.width+6, y:rightEar.y*canvasElement.height-16 };
        let neckPos = { x:neck.x*canvasElement.width-8, y:neck.y*canvasElement.height+10 };
        smoothedFacePoints.leftEar = smoothPoint(smoothedFacePoints.leftEar, leftEarPos);
        smoothedFacePoints.rightEar = smoothPoint(smoothedFacePoints.rightEar, rightEarPos);
        smoothedFacePoints.neck = smoothPoint(smoothedFacePoints.neck, neckPos);
        if (earringImg) {
          const w=earringImg.width*earringScale, h=earringImg.height*earringScale;
          ctx.drawImage(earringImg, smoothedFacePoints.leftEar.x-w/2, smoothedFacePoints.leftEar.y, w,h);
          ctx.drawImage(earringImg, smoothedFacePoints.rightEar.x-w/2, smoothedFacePoints.rightEar.y, w,h);
        }
        if (necklaceImg) {
          const w=necklaceImg.width*necklaceScale, h=necklaceImg.height*necklaceScale;
          ctx.drawImage(necklaceImg, smoothedFacePoints.neck.x-w/2, smoothedFacePoints.neck.y, w,h);
        }
      }
    }
  </script>
</body>
</html>
