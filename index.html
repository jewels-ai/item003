<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Jewels Try-On</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel&family=Poppins&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel&family=Poppins&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body, html {
      width: 100%; height: 100%;
      background-color: #0b0b0b;
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }

    video, canvas {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 1;
    }

    #branding {
      position: fixed; top: 21px; left: 20px;
      padding: 8px 12px; border-radius: 10px;
      display: flex; align-items: center;
      z-index: 5; font-family: 'Cinzel', serif;
      font-size: 24px; color: #000;
    }
    #branding img { width: 80px; height: auto; margin-right: 10px; }

    /* Hidden jewelry options */
    .options-group { display: none; }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const videoElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('overlay');
    const canvasCtx = canvasElement.getContext('2d');

    let necklaceImg = null;
    let smoothedFaceLandmarks = null, camera;
    let smoothedFacePoints = {};

    // âœ… Product direct image link
    const PRODUCT_SRC = "https://drive.google.com/thumbnail?id=1-CngLL7cSgZiYwuX_g5owGN2S0ZtMtb3&sz=w1000";

    async function loadImage(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }

    async function loadJewelryProduct() {
      const img = await loadImage(PRODUCT_SRC);
      if (img) necklaceImg = img;
    }

    const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
    faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.6, minTrackingConfidence:0.6 });
    faceMesh.onResults((results) => {
      canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);
      if (results.multiFaceLandmarks?.length>0) {
        const newLandmarks = results.multiFaceLandmarks[0];
        if (!smoothedFaceLandmarks) smoothedFaceLandmarks = newLandmarks;
        else {
          const factor=0.2;
          smoothedFaceLandmarks = smoothedFaceLandmarks.map((prev,i)=>({
            x: prev.x*(1-factor)+newLandmarks[i].x*factor,
            y: prev.y*(1-factor)+newLandmarks[i].y*factor,
            z: prev.z*(1-factor)+newLandmarks[i].z*factor,
          }));
        }
      } else smoothedFaceLandmarks = null;
      drawJewelry(smoothedFaceLandmarks, canvasCtx);
    });

    async function startCamera(facingMode) {
      if (camera) camera.stop();
      camera = new Camera(videoElement, {
        onFrame: async () => { await faceMesh.send({ image: videoElement }); },
        width:1280, height:720, facingMode:facingMode
      });
      camera.start();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadJewelryProduct(); 
      startCamera('user');
    });

    videoElement.addEventListener('loadedmetadata', () => {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;
    });

    function smoothPoint(prev, current, factor = 0.4) {
      if (!prev) return current;
      return { x: prev.x*(1-factor)+current.x*factor, y: prev.y*(1-factor)+current.y*factor };
    }

    function drawJewelry(faceLandmarks, ctx) {
      const necklaceScale = 0.45;
      if (faceLandmarks && necklaceImg) {
        const neck = faceLandmarks[152];
        let neckPos = { x:neck.x*canvasElement.width-8, y:neck.y*canvasElement.height+10 };
        smoothedFacePoints.neck = smoothPoint(smoothedFacePoints.neck, neckPos);
        const w=necklaceImg.width*necklaceScale, h=necklaceImg.height*necklaceScale;
        ctx.drawImage(necklaceImg, smoothedFacePoints.neck.x-w/2, smoothedFacePoints.neck.y, w,h);
      }
    }

    /* ========= Disable Right-Click & Developer Shortcuts ========= */
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    document.addEventListener('keydown', (e) => {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.key.toLowerCase() === "u") ||
        (e.ctrlKey && e.shiftKey && ["i","j","c"].includes(e.key.toLowerCase()))
      ) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
